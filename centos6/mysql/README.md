
MySQL 5.1 on Centos 6 image
===================

This image contains the MySQL version 5.1 enhanced to support an higher INNODB and MYISAM load. The  MySQL [tuning-primer.sh](https://launchpad.net/mysql-tuning-primer) script is provided inside the image in order to monitor database configuration. All MySQL data are written in `/var/lib/mysql` as a `VOLUME`. The `mysql_install_db` script is loaded in order to generate MySQL data directory for the first time. This directory is not generated by providing a MySQL `datadir` using docker volumes.

## Build the image

Build a MySQL image like this

```bash
$ docker build --rm -t bunop/centos6-mysql .
$ docker tag bunop/centos6-mysql:latest bunop/centos6-mysql:0.1
```

## Create a volume container for data dir

This practice is not strongly suggested but could facilitate data backup

```bash
$ docker create --name mysql-volume -v $PWD/mysql-data:/var/lib/mysql \
  bunop/centos6-mysql /bin/true
```

## Run the image

You can run MySQL image and export MySQL `datadir` directory using a command like this:

```bash
$ docker run -d -P --volumes-from mysql-volume -v /etc/localtime:/etc/localtime:ro \
  --name mysql bunop/centos6-mysql
```

If the container is created for the first time, MySQL `datadir` is created. By passing an already
defined MySQL `datadir`, server start immediately without generate this directory.

**PLEASE REMEMBER TO SET A PASSWORD FOR THE MySQL root USER!** To do so, start the container, and enter it:

```bash
$ docker exec -ti <container-name> /bin/bash
```

then  issue the following commands:

```bash

/usr/bin/mysqladmin -u root password 'new-password'
/usr/bin/mysqladmin -u root -h 657f2447b4e4 password 'new-password'

# Alternatively you can run:
/usr/bin/mysql_secure_installation
```

## Connect to MySQL database outside container

In order to connect into database outside MySQL container, you have to create **at least** one user and setting from where the connection will be valid (root can only connect inside container). Enter the container and connect
to MySQL client simply by typing `mysql`, then:

```sql
CREATE USER 'user'@'%' IDENTIFIED BY 'some_pass';
```
You can then grant privileges on specific databases.

## Running tuning-primer inside container

Enter the container with `docker exec` and then type:

```bash
$ tuning-primer.sh
```

## MySQL Benchmarking with Sysbench

You can test MySQL performance with sysbench. You can find some tips [here](http://blog.flux7.com/blogs/benchmarks/using-sysbench-to-benchmark-mysql). First, you have to create a running MySQL container. Then you have to create at lest one user and grant him all privileges to the benchmarking database (the default test database is ok). Then you have to create benchmarking data inside database:

```bash
$ sysbench --test=oltp --oltp-table-size=1000000 --mysql-host=192.168.13.7 \
  --mysql-port=49215 --mysql-db=test --mysql-user=paolo prepare
```
the `--test=oltp` is the MySQL test type (sysbench can test also memory and CPU). The `--oltp-table-size` is the dimension of the test table. You can set an higher value but you will need more time to fill the table with test data. Other options are the server in which the MySQL container run and the port listenig for MySQL connections. The final `prepare` command is the *fill data* step of this test. Then you can run test with a command line like this:

```bash
$ sysbench --test=oltp --oltp-table-size=1000000 --mysql-host=192.168.13.7 \
  --mysql-port=49215 --mysql-db=test --mysql-user=paolo --oltp-test-mode=complex \
  --num-threads=32 --max-time=60 --max-requests=10000 run
```

the `--oltp-test-mode` is a type of test in which each thread runs advanced transactional queries, including range queries, range SUM, range ORDER by, inserts and updates on index, as well as non-index columns, delete rows. The `--num-threads` is the number of threads used for the test (client side!). `--max-time` is a walltime for doing the whole test. The `--max-requests` is the number of request performed by each thread.
